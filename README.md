# GOV.UK Synthetic test app

This is a synthetic test app used to run Ginkgo tests to test aspects of the GOV.UK infrastructure.

## Deploying the tests on EKS

To deploy the tests you will need to merge in your changes to the `main` branch and then update the image tag in the [govuk-helm-charts repo](https://github.com/alphagov/govuk-helm-charts/blob/main/charts/govuk-synthetic-test-app/values.yaml#L2) to the latest release.

NOTE - 
There is currently an issue with the ECR pull through cache which means that it is not able to pull the latest image from GHCR. So to manually pull the image through to ECR you will need to follow these steps - 

- wait until the latest image is available on [GHCR](https://github.com/alphagov/govuk-synthetic-test-app/pkgs/container/govuk%2Fgovuk-synthetic-test-app)
- assume your `fulladmin` role in the `production` environment
- run these commands -

```
aws ecr get-login-password --region eu-west-1 | docker login --username AWS --password-stdin 172025368201.dkr.ecr.eu-west-1.amazonaws.com

docker pull 172025368201.dkr.ecr.eu-west-1.amazonaws.com/github/alphagov/govuk/govuk-synthetic-test-app:<latest release version>
```

## Running Ginkgo tests locally

NOTE - at the moment the tests only work when deployed on to an EKS cluster as it is using the synthetic-test-assumer role.

The image tag in the manifest is the most recent build generated by a merge into main or a manual trigger of the [build-runner](.github/workflows/build-runner.yaml) workflow in [github actions](https://github.com/alphagov/govuk-synthetic-test-app/actions). You can set it to latest to always use the latest build or target a specific release from the list of [packages available](https://github.com/alphagov/govuk-synthetic-test-app/pkgs/container/govuk%2Fgovuk-synthetic-test-app-runner).

The following commands target integration, replace integration with staging / production to target those environments.

- Before running the tests please ensure that the correct kubectl context is set, eg

`kubectl config use-context govuk-integration`

- To get the tests running you will need to apply this manifest

`gds aws govuk-integration-platformengineer -- kubectl apply -f ./govuk-synthetic-test-app.yaml -n apps`

- To see the results of the tests you can run this kubectl command

`gds aws govuk-integration-platformengineer -- kubectl logs govuk-synthetic-test-app-runner -n apps`

- To delete the pod after the tests have completed run this kubectl command

`gds aws govuk-integration-platformengineer -- kubectl delete -f ./govuk-synthetic-test-app.yaml -n apps`
